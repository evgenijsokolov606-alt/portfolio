<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Portfolio Ultimate (No Lag)</title>
    
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        /* --- ОПТИМИЗАЦИЯ ПРОИЗВОДИТЕЛЬНОСТИ --- */
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }
        
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            font-family: 'Inter', sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
            /* Аппаратное ускорение для всей страницы */
            transform: translateZ(0);
        }
        body { background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }

        /* --- СЦЕНА --- */
        .fullpage-container {
            height: 100%; width: 100%;
            will-change: transform; transition: transform 0s; 
        }
        .section {
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; position: relative;
        }
        .carousel-container {
            width: 100%; height: 55vh;
            perspective: 850px; 
            position: relative; display: flex; justify-content: center; align-items: center;
            cursor: grab;
            /* Оптимизация скролла */
            touch-action: pan-y;
        }
        .carousel-container:active { cursor: grabbing; }

        .carousel {
            width: 100%; height: 100%;
            position: absolute; transform-style: preserve-3d;
            will-change: transform; /* Подсказка браузеру */
        }
        
        /* --- РАЗМЕРЫ --- */
        :root {
            --w: 240px;
            --h: 460px;
        }

        .card {
            position: absolute;
            width: var(--w); height: var(--h);
            left: 50%; top: 50%;
            margin-left: calc(var(--w) / -2); 
            margin-top: calc(var(--h) / -2); 
            transform-style: preserve-3d;
            cursor: pointer; z-index: 10; 
            /* Оптимизация отрисовки */
            backface-visibility: hidden;
        }

        .phone-body { 
            width: 100%; height: 100%; 
            position: relative; 
            transform-style: preserve-3d; 
            transform-origin: center center;
            transition: transform 1s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
        }

        /* --- СЛОИ СТЕКЛА --- */
        .layer {
            position: absolute;
            inset: 0;
            border-radius: 30px;
            pointer-events: none;
            backface-visibility: hidden; /* Важно для производительности */
        }

        .layer.front {
            transform: translateZ(4px); 
            z-index: 20;
            overflow: hidden;
            background: #111; /* Цвет фона пока грузится видео */
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1); 
            pointer-events: auto;
        }

        .layer.inner {
            background: rgba(255, 255, 255, 0.15); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.4); 
        }
        .layer:nth-child(2) { transform: translateZ(2px); }
        .layer:nth-child(3) { transform: translateZ(0px); } 
        .layer:nth-child(4) { transform: translateZ(-2px); }

        .layer.back {
            transform: translateZ(-4px); 
            background: #111;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }

        /* --- СТАТИСТИКА --- */
        .stats-badge {
            position: absolute; bottom: 20px; left: 15px;
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 14px; border-radius: 14px;
            color: #fff; font-size: 13px; font-weight: 700;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 30;
        }
        .stats-badge svg { width: 14px; height: 14px; fill: #00ff88; filter: drop-shadow(0 0 5px rgba(0,255,136,0.8)); }

        /* --- КНОПКА ЗВУКА --- */
        .sound-toggle {
            position: fixed; top: 25px; right: 25px;
            width: 50px; height: 50px;
            background: radial-gradient(circle at 30% 30%, rgba(60,60,60,0.9), #000);
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-bottom-width: 4px; 
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: transform 0.1s, border-width 0.1s;
        }
        .sound-toggle:active { transform: scale(0.95) translateY(2px); border-bottom-width: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .sound-toggle svg { width: 24px; height: 24px; fill: white; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); }
        .sound-off { display: block; } .sound-on { display: none; }
        .sound-toggle.active { border-color: #00ff88; background: radial-gradient(circle at 30% 30%, rgba(0, 50, 20, 0.9), #000); }
        .sound-toggle.active .sound-off { display: none; } .sound-toggle.active .sound-on { display: block; }

        /* --- 3D МОДЕЛЬ --- */
        .tg-3d-wrapper {
            position: fixed; top: 25px; left: 25px; 
            width: 80px; height: 80px;
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            animation: float 3s ease-in-out infinite;
            transition: transform 0.1s ease;
            cursor: pointer;
        }
        model-viewer {
            width: 100%; height: 100%;
            --poster-color: transparent; background-color: transparent; pointer-events: none; 
            filter: saturate(1.5) brightness(1.1) drop-shadow(0 0 15px rgba(42, 171, 238, 0.6));
        }
        .tg-link-overlay { position: absolute; inset: 0; z-index: 2005; }
        .tg-3d-wrapper:active { transform: scale(0.9); animation: none; }
        @keyframes float { 0%, 100% { transform: translateY(0) rotateZ(0deg); } 50% { transform: translateY(-8px) rotateZ(2deg); } }

        /* --- КОНТЕНТ --- */
        .crack-layer {
            position: absolute; inset: 0;
            background-image: url('crack.png'); 
            background-size: 110%; background-position: center; background-repeat: no-repeat;
            opacity: 0; z-index: 50; 
            transition: opacity 0.05s linear;
        }
        .video-container {
            position: absolute; inset: 0; background: #000;
            transition: filter 0.2s ease;
            /* Скругляем углы видео, чтобы не торчали */
            border-radius: 28px; 
            overflow: hidden;
        }
        .layer.front video { width: 100%; height: 100%; object-fit: cover; display: block; }

        /* --- ИНТЕРАКТИВ --- */
        .card.is-tilted .layer.inner {
            border-color: rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
        }
        .card.is-tilted .layer.back { box-shadow: 0 0 40px rgba(255, 255, 255, 0.6); }

        .card.broken .crack-layer { opacity: 1; transform: scale(1.05); }
        .card.broken .video-container { filter: contrast(1.5) brightness(1.3) grayscale(0.6); }
        .card.broken .layer.front { border-color: #fff; box-shadow: 0 0 50px rgba(255,255,255,1); }
        .card.broken .phone-body { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        
        @keyframes shake {
            0% { transform: translate(0, 0) rotate(0deg); } 20% { transform: translate(-3px, 0) rotate(-1deg); }
            40% { transform: translate(3px, 0) rotate(1deg); } 60% { transform: translate(-3px, 0) rotate(0deg); }
            80% { transform: translate(3px, 0) rotate(-1deg); } 100% { transform: translate(0, 0) rotate(0deg); }
        }
        
        .pagination {
            position: fixed; right: 15px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 20px; z-index: 9999;
        }
        .dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .dot.active { background: #fff; transform: scale(1.4); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
    </style>
</head>
<body>

<audio id="snd-click" src="tunetank.com_tap-metallic-(small).wav" preload="auto"></audio>
<audio id="snd-break" src="break.mp3" preload="auto"></audio>
<audio id="snd-swipe" src="swipe.mp3" preload="auto"></audio>
<audio id="snd-trans" src="transition.mp3" preload="auto"></audio>

<div class="sound-toggle" id="sound-btn">
    <svg class="sound-off" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
    <svg class="sound-on" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
</div>

<div class="tg-3d-wrapper">
    <a href="https://t.me/sea120587" target="_blank" class="tg-link-overlay"></a>
    <model-viewer src="telegram.glb" shadow-intensity="1.5" exposure="1.2" tone-mapping="neutral" environment-image="neutral" disable-zoom disable-pan interaction-prompt="none" camera-orbit="0deg 90deg 2.5m"></model-viewer>
</div>

<div class="fullpage-container">
    
    <div class="section"><div class="carousel-container"><div class="carousel">
        <div class="card"><div class="phone-body">
            <div class="layer front">
                <div class="crack-layer"></div>
                <div class="video-container">
                    <video loop muted playsinline poster="poster_1.jpg">
                        <source data-src="1.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="stats-badge"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> 1.2M</div>
            </div>
            <div class="layer inner"></div><div class="layer inner"></div><div class="layer inner"></div><div class="layer back"></div>
        </div></div>
        
        <div class="card"><div class="phone-body">
            <div class="layer front">
                <div class="crack-layer"></div>
                <div class="video-container">
                    <video loop muted playsinline poster="poster_01.jpg">
                        <source data-src="01.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="stats-badge"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> 850K</div>
            </div>
            <div class="layer inner"></div><div class="layer inner"></div><div class="layer inner"></div><div class="layer back"></div>
        </div></div>
        
        <div class="card"><div class="phone-body">
            <div class="layer front">
                <div class="crack-layer"></div>
                <div class="video-container">
                    <video loop muted playsinline poster="poster_001.jpg">
                        <source data-src="001.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="stats-badge"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> 2.4M</div>
            </div>
            <div class="layer inner"></div><div class="layer inner"></div><div class="layer inner"></div><div class="layer back"></div>
        </div></div>
    </div></div></div>

    <div class="section"><div class="carousel-container"><div class="carousel">
        <div class="card"><div class="phone-body">
            <div class="layer front">
                <div class="crack-layer"></div>
                <div class="video-container">
                    <video loop muted playsinline poster="poster_02.jpg">
                        <source data-src="02.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="stats-badge"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> 400K</div>
            </div>
            <div class="layer inner"></div><div class="layer inner"></div><div class="layer inner"></div><div class="layer back"></div>
        </div></div>
        <div class="card"><div class="phone-body">
            <div class="layer front">
                <div class="crack-layer"></div>
                <div class="video-container">
                    <video loop muted playsinline poster="poster_002.jpg">
                        <source data-src="002.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="stats-badge"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> 90K</div>
            </div>
            <div class="layer inner"></div><div class="layer inner"></div><div class="layer inner"></div><div class="layer back"></div>
        </div></div>
        <div class="card"><div class="phone-body">
            <div class="layer front">
                <div class="crack-layer"></div>
                <div class="video-container">
                    <video loop muted playsinline poster="poster_0002.jpg">
                        <source data-src="0002.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="stats-badge"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> 1.1M</div>
            </div>
            <div class="layer inner"></div><div class="layer inner"></div><div class="layer inner"></div><div class="layer back"></div>
        </div></div>
    </div></div></div>

    <div class="section"><div class="carousel-container"><div class="carousel">
        <div class="card"><div class="phone-body">
            <div class="layer front">
                <div class="crack-layer"></div>
                <div class="video-container">
                    <video loop muted playsinline poster="poster_03.jpg">
                        <source data-src="03.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="stats-badge"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> 500K</div>
            </div>
            <div class="layer inner"></div><div class="layer inner"></div><div class="layer inner"></div><div class="layer back"></div>
        </div></div>
        <div class="card"><div class="phone-body">
            <div class="layer front">
                <div class="crack-layer"></div>
                <div class="video-container">
                    <video loop muted playsinline poster="poster_003.jpg">
                        <source data-src="003.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="stats-badge"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> 300K</div>
            </div>
            <div class="layer inner"></div><div class="layer inner"></div><div class="layer inner"></div><div class="layer back"></div>
        </div></div>
        <div class="card"><div class="phone-body">
            <div class="layer front">
                <div class="crack-layer"></div>
                <div class="video-container">
                    <video loop muted playsinline poster="poster_0003.jpg">
                        <source data-src="0003.mp4" type="video/mp4">
                    </video>
                </div>
                <div class="stats-badge"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> 770K</div>
            </div>
            <div class="layer inner"></div><div class="layer inner"></div><div class="layer inner"></div><div class="layer back"></div>
        </div></div>
    </div></div></div>

</div>

<div class="pagination">
    <div class="dot active"></div>
    <div class="dot"></div>
    <div class="dot"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // ПАРАМЕТРЫ
    const CARD_DISTANCE = 150; 
    const ROTATION_SENSITIVITY = 0.5;
    const LOCK_THRESHOLD = 8;
    const TILT_ANGLE = 5; 
    const CENTER_ZONE_RADIUS = 0.35; 

    // АУДИО
    const soundClick = document.getElementById('snd-click'); 
    const soundBreak = document.getElementById('snd-break');
    const soundSwipe = document.getElementById('snd-swipe');
    const soundTrans = document.getElementById('snd-trans');
    
    const playSound = (audio) => { if(audio) { audio.currentTime = 0; audio.play().catch(e => {}); }};

    const soundBtn = document.getElementById('sound-btn');
    let isMuted = true;
    
    soundBtn.addEventListener('click', () => {
        isMuted = !isMuted;
        soundBtn.classList.toggle('active', !isMuted);
        // Включаем звук только на активном видео
        document.querySelectorAll('video').forEach(vid => {
            if(!vid.paused) vid.muted = isMuted;
        });
        if(!isMuted && navigator.vibrate) navigator.vibrate(50);
    });

    const container = document.querySelector('.fullpage-container');
    const carousels = document.querySelectorAll('.carousel');
    const dots = document.querySelectorAll('.dot');
    const cards = document.querySelectorAll('.card');
    
    let currentSection = 0;
    const carouselIndices = new Array(carousels.length).fill(0); 
    const windowHeight = window.innerHeight;

    carousels.forEach(carousel => {
        const c_cards = Array.from(carousel.querySelectorAll('.card'));
        const step = 360 / c_cards.length;
        c_cards.forEach((card, i) => {
            card.style.transform = `rotateY(${i * step}deg) translateZ(${CARD_DISTANCE}px)`;
        });
    });

    let isMoved = false;

    cards.forEach(card => {
        card.addEventListener('click', (e) => {
            if (isMoved) return; 
            if (card.classList.contains('broken')) return;

            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left; 
            const y = e.clientY - rect.top;  
            const w = rect.width;
            
            const centerX = w / 2;
            const centerY = rect.height / 2;
            const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
            const zoneRadius = w * CENTER_ZONE_RADIUS;

            const body = card.querySelector('.phone-body');

            if (dist < zoneRadius) {
                if (navigator.vibrate) navigator.vibrate(200);
                playSound(soundBreak);
                card.classList.add('broken');
                setTimeout(() => { card.classList.remove('broken'); }, 3000);
            } else {
                playSound(soundClick);
                const percentX = (x - centerX) / centerX;
                const percentY = (y - centerY) / centerY;
                const rotY = percentX * TILT_ANGLE; 
                const rotX = -percentY * TILT_ANGLE;
                
                body.style.transition = 'transform 0.1s ease-out';
                body.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg) scale(0.98)`;
                card.classList.add('is-tilted');

                setTimeout(() => {
                    body.style.transition = 'transform 1s cubic-bezier(0.2, 0.8, 0.2, 1)';
                    body.style.transform = ''; 
                    card.classList.remove('is-tilted');
                }, 150);
            }
        });
    });

    function snapToSection() {
        container.style.transition = 'transform 0.6s cubic-bezier(0.2, 0.9, 0.1, 1)';
        container.style.transform = `translateY(-${currentSection * 100}%)`;
        
        // ОПТИМИЗАЦИЯ: Ставим все видео на паузу при смене этажа
        document.querySelectorAll('video').forEach(v => {
            v.pause();
            v.removeAttribute('src'); // Удаляем из памяти
            v.load(); 
        });

        const activeCarousel = carousels[currentSection];
        // Небольшая задержка, чтобы анимация скролла прошла плавно перед загрузкой видео
        setTimeout(() => {
            playActiveVideo(activeCarousel, carouselIndices[currentSection]);
        }, 300);
        
        dots.forEach((dot, idx) => dot.classList.toggle('active', idx === currentSection));
        playSound(soundTrans);
    }

    // --- ГЛАВНАЯ ФУНКЦИЯ ОПТИМИЗАЦИИ (Lazy Load) ---
    function playActiveVideo(carousel, index) {
        const c_cards = carousel.querySelectorAll('.card');
        const count = c_cards.length;
        let realIndex = ((index % count) + count) % count;

        c_cards.forEach((card, i) => {
            const video = card.querySelector('video');
            const source = video.querySelector('source');
            
            if (i === realIndex) {
                // ЭТО АКТИВНАЯ КАРТОЧКА
                if (!video.getAttribute('src')) {
                    // Если видео еще не загружено - загружаем его
                    const videoSrc = source.getAttribute('data-src');
                    if (videoSrc) {
                        video.src = videoSrc;
                        video.muted = isMuted;
                        video.load();
                        video.play().catch(e => console.log('Autoplay blocked', e));
                    }
                } else {
                    // Если уже было загружено - просто играем
                    video.muted = isMuted;
                    video.play().catch(e => {});
                }
            } else {
                // ЭТО ФОНОВАЯ КАРТОЧКА
                // Полностью убиваем видео, чтобы освободить память
                if (video.getAttribute('src')) {
                    video.pause();
                    video.removeAttribute('src');
                    video.load(); // Применяем очистку
                }
            }
        });
    }

    let startX = 0, startY = 0;
    let direction = null; 
    let lastDiffX = 0, lastDiffY = 0; 
    let currentCarousel = null;
    let startRotation = 0;
    let currentRotation = 0;
    let startYPos = 0;
    let isDragging = false; 

    const handleStart = (clientX, clientY) => {
        startX = clientX;
        startY = clientY;
        isDragging = true;
        isMoved = false; 
        direction = null;
        lastDiffX = 0; lastDiffY = 0;

        currentCarousel = carousels[currentSection];
        currentCarousel.style.transition = 'none';
        
        const count = currentCarousel.querySelectorAll('.card').length;
        startRotation = -(carouselIndices[currentSection] * (360 / count));
        currentRotation = startRotation;

        container.style.transition = 'none';
        startYPos = -(currentSection * windowHeight); 
    };

    const handleMove = (clientX, clientY, e) => {
        if (!isDragging) return;
        const diffX = clientX - startX;
        const diffY = clientY - startY;
        
        if (Math.abs(diffX) > 5 || Math.abs(diffY) > 5) isMoved = true;
        lastDiffX = diffX; lastDiffY = diffY;

        if (!direction) {
            if (Math.abs(diffX) > LOCK_THRESHOLD || Math.abs(diffY) > LOCK_THRESHOLD) {
                if (Math.abs(diffX) > Math.abs(diffY)) direction = 'horizontal';
                else direction = 'vertical';
            } else { return; }
        }

        if (direction === 'horizontal') {
            if(e) e.preventDefault(); 
            currentRotation = startRotation + (diffX * ROTATION_SENSITIVITY);
            currentCarousel.style.transform = `rotateY(${currentRotation}deg)`;
        }
        
        if (direction === 'vertical') {
            if(e) e.preventDefault();
            let resistance = 1;
            if ((currentSection === 0 && diffY > 0) || (currentSection === carousels.length - 1 && diffY < 0)) resistance = 0.4; 
            const newTranslateY = startYPos + (diffY * resistance);
            container.style.transform = `translateY(${newTranslateY}px)`;
        }
    };

    const handleEnd = () => {
        isDragging = false;
        if (!isMoved && !direction) return; 

        if (direction === 'horizontal') {
            const count = currentCarousel.querySelectorAll('.card').length;
            const anglePerCard = 360 / count;
            let nearestIndex = Math.round(-currentRotation / anglePerCard);
            
            if(carouselIndices[currentSection] !== nearestIndex) playSound(soundSwipe);
            
            carouselIndices[currentSection] = nearestIndex;
            currentCarousel.style.transition = 'transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1)';
            currentCarousel.style.transform = `rotateY(${-(nearestIndex * anglePerCard)}deg)`;
            
            // Запускаем видео только после окончания анимации
            setTimeout(() => {
                playActiveVideo(currentCarousel, nearestIndex);
            }, 100);
        }

        if (direction === 'vertical') {
            const thresholdPx = windowHeight * 0.10;
            const diffY = lastDiffY;
            if (diffY < -thresholdPx && currentSection < carousels.length - 1) currentSection++;
            else if (diffY > thresholdPx && currentSection > 0) currentSection--;
            snapToSection();
        }
    };

    window.addEventListener('touchstart', (e) => handleStart(e.touches[0].clientX, e.touches[0].clientY), {passive: false});
    window.addEventListener('touchmove', (e) => handleMove(e.touches[0].clientX, e.touches[0].clientY, e), {passive: false});
    window.addEventListener('touchend', handleEnd);

    window.addEventListener('mousedown', (e) => handleStart(e.clientX, e.clientY));
    window.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY, e));
    window.addEventListener('mouseup', handleEnd);

    // Запускаем первое видео на старте
    playActiveVideo(carousels[0], 0);
});
</script>

</body>
</html>
